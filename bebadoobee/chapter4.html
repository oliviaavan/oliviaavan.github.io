<!DOCTYPE html>
<html lang="en">

<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <meta http-equiv="Cache-Control" content="no-cache, no-store, must-revalidate" />
 
  <title>Chapter 4</title>

  <style>
    html, body {
      margin: 0;
      padding: 0;
      height: 100%;
      overflow: hidden;
      background: black;
    }

    .interval-container {
      display: none;
      height: 100vh;
      width: 100vw;
      justify-content: center;
      align-items: center;
      position: relative;
    }

    #intervalImage {
      width: 100%;
      height: 100%;
      object-fit: cover;
      opacity: 0;
      transition: opacity 0.5s ease-in-out;
    }

    #finalBtn {
      position: absolute;
      top: 90%;
      left: 50%;
      z-index: 9;
      padding: 20px 40px;
      font-size: 1.5rem;
      background: rgba(0, 0, 0, 0.9);
      color: white;
      border: none;
      border-radius: 8px;
      cursor: pointer;
      display: none;
      transform: translate(-50%, -50%);
    }

    #finalBtn:hover {
      background: rgba(0, 0, 0, 0.9);;
    }
  </style>
</head>

<body>
  <div class="interval-container" id="intervalContainer">
    <img id="intervalImage" src="" alt="Chapter 4 Image">
    <button id="finalBtn" onclick="location.href='chapter5.html'">snap back to reality</button>
  </div>

  <script>
    let audioContext = new (window.AudioContext || window.webkitAudioContext)();
    let buffer = null;
    let source = null;

    fetch('audio/disappearchapter4.wav')
      .then(response => response.arrayBuffer())
      .then(arrayBuffer => audioContext.decodeAudioData(arrayBuffer))
      .then(decodedBuffer => {
        buffer = decodedBuffer;
        console.log('Audio loaded. Duration: ' + buffer.duration + 's');
      });

    document.body.addEventListener('click', function startAudio() {
      if (!buffer) {
        console.log('Buffer still loading...');
        return;
      }

      if (source) {
        console.log('Already playing.');
        return;
      }

      source = audioContext.createBufferSource();
      source.buffer = buffer;
      source.loop = true;
      source.loopStart = 0; 
      source.loopEnd = buffer.duration; 

      source.connect(audioContext.destination);
      source.start(0);

      document.body.removeEventListener('click', startAudio);
      console.log('Audio started with loopStart 0 and loopEnd ' + buffer.duration);
    });

    const intervalContainer = document.getElementById("intervalContainer");
    const intervalImage = document.getElementById("intervalImage");
    const finalBtn = document.getElementById("finalBtn");

    const sequence1 = Array.from({length: 8}, (_, i) => `images/chapter9/${String(i + 96).padStart(3, '0')}risograph.png`);
    const sequence2 = Array.from({length: 11}, (_, i) => `images/chapter8/${String(i + 85).padStart(3, '0')}risograph.png`);
    const sequence3 = Array.from({length: 6}, (_, i) => `images/chapter10/${String(i + 104).padStart(3, '0')}risograph.png`);
    const sequence4 = Array.from({length: 5}, (_, i) => `images/chapter11/${String(i + 110).padStart(3, '0')}risograph.png`);

    const sequences = [sequence1, sequence2, sequence3, sequence4];

    let currentSequenceIndex = 0;
    let intervalIndex = 0;
    let intervalTimer;

    function showIntervalImage() {
      const currentSequence = sequences[currentSequenceIndex];

      if (intervalIndex < currentSequence.length) {
        if (intervalIndex === 0) {
          intervalImage.style.opacity = 0;
          setTimeout(() => {
            intervalImage.src = currentSequence[intervalIndex];
            intervalImage.onload = () => {
              intervalImage.style.opacity = 1;
            };
            intervalIndex++;
          }, 180); // wait for fade to start before loading the next image
        } else {
          intervalImage.src = currentSequence[intervalIndex];
          intervalIndex++;
        }
      } else {
        clearInterval(intervalTimer);
        currentSequenceIndex++;

        if (currentSequenceIndex < sequences.length) {
          intervalIndex = 0;
          setTimeout(() => {
            intervalTimer = setInterval(showIntervalImage, 180);
          }, 250);
        } else {
          setTimeout(() => {
            finalBtn.style.display = "block"; // show final button after all sequences
          }, 500);
        }
      }
    }

    function startImageInterval() {
      intervalContainer.style.display = 'flex';
      intervalTimer = setInterval(showIntervalImage, 180);
    }

    const urlParams = new URLSearchParams(window.location.search);
    if (urlParams.get('autoplay') === 'true') {
      startImageInterval();
    }
  </script>
</body>

</html>
